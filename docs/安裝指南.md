# YSCP Line Bot 安裝指南

## 🎯 系統需求

**支援平台**: Windows、macOS、Linux  
**必要軟體**: Node.js（已內嵌在安裝檔中）  
**必要帳號**: YSCP API 憑證、Line Bot 憑證、有效的授權（SerialNumber + License Key）

## 🚀 安裝流程

### Windows 平台

#### 步驟 1：下載安裝檔

從官方渠道獲取 `YSCP-Line-Bot-Setup.exe` 安裝檔。

#### 步驟 2：執行安裝精靈

1. **歡迎畫面**：閱讀軟體說明，點擊「下一步」繼續
2. **授權協議**：閱讀授權協議，選擇「我接受協議」，點擊「下一步」
3. **選擇安裝目錄**：預設 `C:\Program Files\YSCP Line Bot`，可自訂安裝路徑
4. **準備安裝**：確認安裝資訊，點擊「安裝」開始安裝
5. **安裝完成**：安裝完成後會自動啟動應用程式

安裝完成後，系統會自動：

- 建立桌面快捷方式
- 建立開始選單項目
- 自動啟動應用程式並開啟設定精靈

### macOS 平台

#### 步驟 1：下載安裝檔

從官方渠道獲取 `YSCP-Line-Bot.dmg` 安裝檔。

#### 步驟 2：執行安裝

1. **掛載磁碟映像**：雙擊 DMG 檔案
2. **安裝應用程式**：將「YSCP Line Bot」拖拽到「Applications」資料夾
3. **首次執行**：
   - 打開「應用程式」資料夾，雙擊「YSCP Line Bot」
   - 如果出現安全提示，前往「系統偏好設定」→「安全性與隱私」允許執行
4. **設定精靈**：首次執行會自動啟動設定精靈

### Linux 平台

#### 步驟 1：下載安裝檔

從官方渠道獲取 `YSCP-Line-Bot.AppImage` 安裝檔。

#### 步驟 2：執行安裝

```bash
# 賦予執行權限
chmod +x YSCP-Line-Bot.AppImage

# 執行安裝檔
./YSCP-Line-Bot.AppImage
```

安裝精靈會引導完成授權驗證、系統配置和服務啟動。

## 🔑 授權驗證

應用程式首次啟動時，會自動開啟設定精靈。在**步驟 1：輸入授權**中：

- **SerialNumber**：輸入從管理員處獲取的序號（例如：SN-001）
- 點擊「啟用授權」，系統會自動連接到授權伺服器獲取對應的 License Key
- 授權啟用成功後，步驟 1 會標記為完成

**注意**：

- 授權必須在授權伺服器中已建立並啟用（狀態為 `active`）
- 請確保網路連接正常，系統會自動連接到預設的授權伺服器
- 授權驗證成功後，後續啟動應用程式時會自動跳過設定步驟，直接進入完整前端

> 📖 詳細授權系統說明請參考 [授權系統測試檢查清單](授權系統測試檢查清單.md)

## ⚙️ 系統配置

在設定精靈的**步驟 2：環境配置**中，需要填寫以下**所有必填項目**：

### 配置項目說明

#### YSCP API 配置（必填）

- **YSCP_HOST**：YSCP 伺服器主機地址（例如：`https://yscp.yenshow.com`）
- **YSCP_AK**：YSCP Access Key（從 YSCP 系統管理員處獲取）
- **YSCP_SK**：YSCP Secret Key（從 YSCP 系統管理員處獲取）

#### Line Bot 配置（必填）

- **LINE_CHANNEL_ACCESS_TOKEN**：Line Bot Channel Access Token（從 [Line Developers Console](https://developers.line.biz/console/) 獲取）
- **LINE_CHANNEL_SECRET**：Line Bot Channel Secret（從 Line Developers Console 獲取）

#### 伺服器配置（必填）

- **PORT**：應用程式監聽端口（預設：`6000`）

#### Webhook 配置（必填）

- **WEBHOOK_URL**：公開的 Webhook URL，用於接收 YSCP 事件推送（需使用 ngrok 或公開域名）
  - 範例：`https://your-domain.com/api/linebot/yscp-event-receiver`
- **EVENT_TOKEN**：事件驗證 Token，用於驗證 YSCP 事件推送的合法性

#### Ngrok 配置（必填）

- **NGROK_AUTHTOKEN**：Ngrok Authtoken（用於本地開發時提供公開 URL）
  - 前往 [Ngrok Dashboard](https://dashboard.ngrok.com/get-started/your-authtoken) 註冊並取得 authtoken
- **NGROK_URL**：公開 URL（如果使用 ngrok，此值會在啟動後自動更新；如果使用固定域名，也可直接填入）

### 配置方式

1. **透過設定精靈**：在步驟 2 中點擊「開啟配置」，會自動開啟 `.env` 檔案供編輯
2. **手動編輯**：直接編輯應用程式目錄下的 `.env` 檔案
3. **自動更新**：設定精靈會自動監聽 `.env` 檔案變化，修改後會自動更新顯示

**重要提示**：

- 所有配置項目都是**必填**，必須完整填寫才能進入下一步
- 配置完成後，點擊「驗證配置」檢查所有必填項目是否已正確設定
- 如果設定完成，後續啟動應用程式時會自動跳過設定步驟，直接進入完整前端

## 🚀 啟動服務

### 首次啟動

1. **啟動應用程式**：從開始選單或桌面快捷方式啟動
2. **完成設定**：按照設定精靈完成授權驗證和環境配置
3. **測試服務**：在步驟 3 中測試服務是否能正常啟動
4. **使用完整前端**：步驟 4 提供完整的服務控制面板

### 後續啟動

如果授權和配置都已完成，應用程式會**自動跳轉到步驟 4（完整前端）**，無需重複設定。

在完整前端中，您可以：

- 啟動/停止服務
- 查看服務日誌
- 開啟配置檔案進行修改

### 命令列啟動（開發模式）

如果需要使用命令列啟動：

```bash
npm start
```

**常用服務管理命令**：

- `npm run restart` - 重啟服務
- `npm run stop` - 停止服務
- `npm run status` - 查看服務狀態
- `npm run logs` - 查看實時日誌

## 🧪 測試安裝

### 快速測試

```bash
# 測試服務健康狀態
curl http://localhost:6000/health

# 測試授權狀態
curl http://localhost:6000/api/license/status

# 執行授權系統測試
npm run test-license

# 執行完整測試
npm run test-all
```

## ✅ 安裝確認

### 確認清單

- [ ] **安裝**: 安裝精靈執行成功，所有檔案已安裝
- [ ] **授權**: 已啟用有效的授權（**必須**，如未啟用，服務將無法啟動）
  - 檢查方式：`curl http://localhost:6000/api/license/status`
- [ ] **配置**: `.env` 檔案已正確設定（所有必填項目）
  - YSCP API 憑證已填入（YSCP_HOST, YSCP_AK, YSCP_SK）
  - Line Bot 憑證已填入（LINE_CHANNEL_ACCESS_TOKEN, LINE_CHANNEL_SECRET）
  - 伺服器配置已填入（PORT）
  - Webhook 配置已填入（WEBHOOK_URL, EVENT_TOKEN）
  - Ngrok 配置已填入（NGROK_AUTHTOKEN, NGROK_URL）
- [ ] **服務**: 服務正常啟動
  - 服務正常啟動（無授權錯誤）
  - 健康檢查通過：`curl http://localhost:6000/health`
- [ ] **Line Bot**: Webhook URL 已設定並啟用
  - 在 Line Developers Console 中設定 Webhook URL
  - Webhook 狀態為「已啟用」
- [ ] **事件**: 事件訂閱已完成（自動或手動執行 `npm run subscribe-events`）
  - 檢查 YSCP 管理介面中的事件訂閱狀態
- [ ] **用戶**: 已透過 Line Bot 或腳本同步用戶
  - 手動同步：`node scripts/user-sync.js`
  - Line Bot 管理：發送「管理」指令（管理員）
- [ ] **管理員**: 至少設定一個管理員用戶（在 `data/user-management.json` 中）

## 🚨 常見問題

### 安裝失敗

**問題**：安裝過程中出現錯誤

**解決方案**：

1. 確認有管理員權限
2. 關閉防毒軟體後重試
3. 檢查磁碟空間是否足夠
4. 查看安裝日誌檔案（Windows: `%TEMP%\YSCP-Line-Bot-Install.log`，macOS/Linux: `/tmp/YSCP-Line-Bot-Install.log`）

### 授權驗證失敗

**問題**：在設定精靈步驟 1 中授權啟用失敗

**解決方案**：

1. **確認 SerialNumber 正確**：檢查輸入的 SerialNumber 是否與管理員提供的完全一致
2. **檢查網路連接**：確保能夠連接到授權伺服器（系統會自動使用預設的授權伺服器）
3. **確認授權狀態**：聯繫管理員確認授權是否已在後台建立並啟用（狀態為 `active`）
4. **常見錯誤訊息**：
   - "SerialNumber 不存在"：請確認 SerialNumber 是否正確，或聯繫管理員建立授權
   - "授權未啟用"：請聯繫管理員在後台啟用授權
   - "連線超時"：檢查網路連接或授權伺服器狀態
   - "無法連接到授權伺服器"：檢查網路連接

如果授權啟用失敗，可以稍後在設定精靈中重新嘗試，或直接編輯授權檔案。

### MAC Address 不匹配

**問題**：授權驗證時顯示 MAC Address 不匹配

**解決方案**：

1. 確認當前 MAC Address：系統會顯示預期和實際的 MAC Address
2. 如果設備更換網卡，需要重新生成授權
3. 聯繫管理員重新生成授權

### 服務無法啟動

**問題**：安裝完成後服務無法啟動

**解決方案**：

1. 檢查授權是否已啟用：`curl http://localhost:6000/api/license/status`
2. 檢查端口是否被占用：
   - Windows: `netstat -ano | findstr :6000`
   - macOS/Linux: `lsof -i :6000`
3. 查看日誌檔案：`logs/error.log`
4. 確認 `.env` 檔案配置正確

### 端口被占用

```bash
# 方法 1: 完全重置服務（推薦）
npm run reset

# 方法 2: 手動處理
# Windows
netstat -ano | findstr :6000
taskkill /PID <PID> /F

# macOS/Linux
lsof -i :6000
kill -9 <PID>
```

### Line Bot 無回應

1. 確認 LINE Channel 配置正確
2. 確認 Webhook URL 已設定並啟用
3. 測試服務：`curl http://localhost:6000/webhook/test`
4. 手動同步用戶：`node scripts/user-sync.js`

### 無法接收事件

1. 檢查 YSCP 管理介面中的事件訂閱設定
2. 確認 Webhook URL 正確設定：`https://您的域名/api/linebot/yscp-event-receiver`
3. 檢查 `data/event-types.json` 中的事件類型配置
4. 查看日誌：
   - `npm run logs-app` - 查看應用程式日誌
   - `npm run logs-error` - 查看錯誤日誌
   - `npm run logs` - 查看所有實時日誌

## 🔄 卸載

- **Windows**：控制台 → 程式和功能 → 卸載，或使用開始選單中的「卸載」快捷方式
- **macOS**：將應用程式拖到垃圾桶
- **Linux**：`npm run stop` 後刪除安裝目錄

> ⚠️ **注意**：卸載前請備份 `data/` 目錄中的配置檔案和授權檔案。

## 🔧 進階配置

### 自訂安裝目錄

在安裝精靈的「選擇安裝目錄」頁面，可以自訂安裝路徑。

### 靜默安裝（Windows）

```cmd
YSCP-Line-Bot-Setup.exe /S /D=C:\Custom\Path
```

參數說明：

- `/S`：靜默安裝（不顯示安裝精靈）
- `/D`：指定安裝目錄

### 安裝後自動啟動

安裝完成後，可以選擇「立即啟動配置精靈」或「稍後手動啟動」。

## 📝 安裝日誌

安裝過程中的日誌會儲存在：

- **Windows**：`%TEMP%\YSCP-Line-Bot-Install.log`
- **macOS/Linux**：`/tmp/YSCP-Line-Bot-Install.log`

如果安裝出現問題，可以查看這些日誌檔案進行除錯。

**版本**: 2.0.0 | **最後更新**: 2025/12/05

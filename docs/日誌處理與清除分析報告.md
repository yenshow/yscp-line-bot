# 日誌處理與清除機制分析報告

## 📋 概述

本專案採用統一的日誌服務 (`LoggerService`) 來管理所有日誌記錄，並透過 `FileSystemService` 進行日誌檔案的清理與維護。系統實現了完整的自動化日誌管理機制，包括日誌輪轉、自動清理、監控告警和統計報告。

---

## 🏗️ 架構設計

### 1. 日誌服務層 (`LoggerService`)

**位置**: `services/loggerService.js`

**核心功能**:

- 統一日誌格式：`[時間戳] [級別] 訊息內容`
- 分類日誌記錄：不同類型的日誌記錄到不同檔案
- 重複訊息過濾：5 秒內相同訊息不重複記錄
- 日誌輪轉：當檔案超過指定大小時自動輪轉
- 定期清理：自動清理超過保留期限的舊日誌
- 監控告警：自動監控日誌目錄容量並發出告警
- 統計報告：自動生成清理統計報告

**日誌分類**:

| 日誌類型               | 記錄檔案                | 用途                          | 備註                          |
| ---------------------- | ----------------------- | ----------------------------- | ----------------------------- |
| `info()`               | `app.log`               | 系統/服務資訊                 | 核心方法，統一 system/service |
| `system()`             | `app.log`               | 系統啟動（向後兼容）          | 內部調用 info()               |
| `service()`            | `app.log`               | 服務狀態（向後兼容）          | 內部調用 info()               |
| `user()`               | `app.log`               | 用戶活動                      |                               |
| `logUserStateChange()` | `app.log`               | 用戶狀態變更（結構化 JSON）   |                               |
| `hcp()`                | `app.log`               | YSCP 事件                      |                               |
| `httpStatus()`         | `app.log` / `error.log` | HTTP 狀態碼（根據狀態碼分類） |                               |
| `error()`              | `error.log`             | 錯誤訊息                      |                               |
| `warn()`               | `error.log`             | 警告訊息                      |                               |
| `debug()`              | 僅控制台                | 調試訊息（開發環境）          |                               |

**已移除的方法**（未使用）:

- ❌ `startup()` - 只在控制台顯示，功能可由 `info()` 代替
- ❌ `httpError()` - 功能可由 `error()` 代替
- ❌ `security()` - 功能可由 `warn()` 代替
- ❌ `performance()` - 功能可由 `info()` 代替
- ❌ `logNewUserActivity()` - 功能可由 `user()` 代替

---

## 📁 日誌檔案結構

### 日誌檔案類型

```
logs/
├── app.log                    # 應用程式主要日誌
├── error.log                  # 錯誤和警告日誌
├── app.log.{timestamp}.bak   # 輪轉備份檔案（.bak 後綴）
└── error.log.{timestamp}.bak  # 輪轉備份檔案（.bak 後綴）
```

### 日誌格式範例

```log
[2025-11-28 11:32:03.993] [HTTP] HTTP 200: YSCP 事件推送回應: 事件已接收 (POST /api/linebot/yscp-event-receiver)
[2025-11-28 11:32:08.336] [WARN] ⚠️ [日誌告警] 日誌目錄容量警告: 520.45MB (85 個檔案)
[2025-11-28 12:00:00.000] [INFO] 📊 [清理統計] 刪除檔案: 3 個 | 釋放空間: 15.23MB | 當前目錄: 125.67MB (12 個檔案)
```

---

## 🧹 日誌清理機制

### 自動清理機制

**啟動位置**: `app.js` 第 200 行

```javascript
LoggerService.scheduleLogMaintenance();
```

**執行頻率**: 每 24 小時執行一次

**執行步驟**:

#### 步驟 0: 日誌目錄監控告警

- **功能**: 檢查日誌目錄狀態並發出告警
- **檢查項目**:
  - 目錄總容量（警告閾值：500MB，嚴重警告：1GB）
  - 檔案數量（警告閾值：100 個檔案）
  - 單檔案大小（警告閾值：50MB）
- **輸出**: 自動記錄告警到 `error.log`
- **方法**: `checkLogDirectoryCapacity()`

#### 步驟 1: 日誌輪轉檢查

- **功能**: 處理過大的日誌檔案
- **輪轉規則**:
  - `app.log`: 超過 10MB 時輪轉
  - `error.log`: 超過 5MB 時輪轉
- **輪轉流程**:
  1. **先記錄**：創建備份檔案（`.bak` 後綴），保存完整內容
  2. **再清空**：確認備份成功後，清空原檔案（保留檔案以繼續寫入）
- **備份檔案格式**: `{原檔名}.{時間戳}.bak`
- **方法**: `rotateLogFile()`

#### 步驟 2: 舊日誌清理

- **功能**: 清理超過保留期限的舊日誌檔案
- **保留期限**: 預設保留 1 年（365 天）
- **清理目標**: 統一清理所有超過保留期限的 `.log` 和 `.bak` 檔案
- **清理規則**: 使用正則表達式 `/\.(log|bak)$/` 匹配檔案
- **方法**: `cleanupOldLogs()`

#### 步驟 3: 清理統計報告

- **功能**: 自動生成清理統計報告
- **報告內容**:
  - 刪除的檔案數量
  - 釋放的空間（MB）
  - 清理前後的目錄大小和檔案數量
  - 當前目錄狀態
- **輸出**: 自動記錄到 `app.log`
- **格式**: `📊 [清理統計] 刪除檔案: X 個 | 釋放空間: XMB | 當前目錄: XMB (X 個檔案)`
- **方法**: `generateCleanupReport()`

### 日誌維護流程圖

```
應用啟動 (app.js)
    ↓
LoggerService.scheduleLogMaintenance()
    ↓
┌──────────────────────────────────────────┐
│  統一日誌維護任務 (每24小時執行一次)      │
│                                          │
│  步驟 0: 日誌目錄監控告警                │
│    - checkLogDirectoryCapacity()        │
│    - 檢查目錄容量（警告/嚴重警告）       │
│    - 檢查檔案數量和單檔案大小            │
│                                          │
│  步驟 1: 日誌輪轉檢查                    │
│    - rotateLogFile("app.log", 10)       │
│    - rotateLogFile("error.log", 5)      │
│    - 先備份 → 再清空（產生 .bak）       │
│                                          │
│  步驟 2: 舊日誌清理                      │
│    - cleanupOldLogs(365)                │
│    - 清理超過 1 年（365 天）的所有檔案   │
│    - 包括 .log 和 .bak 檔案             │
│                                          │
│  步驟 3: 生成清理統計報告                │
│    - generateCleanupReport()            │
│    - 記錄刪除檔案數量和釋放空間          │
│    - 記錄當前目錄狀態                    │
└──────────────────────────────────────────┘
```

### 清理邏輯實現

**位置**: `services/loggerService.js`

**核心方法**:

```javascript
// 清理舊日誌檔案（返回統計資訊）
cleanupOldLogs(daysToKeep = 365) {
    // 清理前統計
    const statsBefore = this.getLogDirectoryStats();
    
    // 執行清理
    const cleanedCount = fileSystem.cleanupExpiredFiles(
        this.logsDir, 
        cutoffTime, 
        /\.(log|bak)$/
    );
    
    // 清理後統計
    const statsAfter = this.getLogDirectoryStats();
    
    // 返回詳細統計
    return {
        cleanedCount,
        freedSpaceMB,
        sizeBeforeMB,
        sizeAfterMB,
        fileCountBefore,
        fileCountAfter
    };
}
```

---

## 📊 日誌管理統計

### 清理任務配置

| 任務類型     | 執行頻率   | 保留期限       | 檔案類型            | 備份檔案類型 |
| ------------ | ---------- | -------------- | ------------------- | ------------ |
| 統一日誌維護 | 每 24 小時 | 1 年（365 天） | `.log`, `.bak` 檔案 | `.bak`       |

**維護內容**:

- **日誌輪轉**: 檢查並輪轉超過大小限制的 `.log` 檔案（app.log: 10MB, error.log: 5MB），創建 `.bak` 備份檔案
- **舊日誌清理**: 清理超過 1 年（365 天）的所有 `.log` 和 `.bak` 檔案
- **監控告警**: 自動監控目錄容量、檔案數量和單檔案大小
- **統計報告**: 自動生成清理統計報告

---

## ⚙️ 配置選項

### 可調整參數

1. **日誌輪轉大小** (`loggerService.js` 第 462-463 行)

   ```javascript
   rotateLogFile("app.log", 10);  // 10MB
   rotateLogFile("error.log", 5); // 5MB
   ```

2. **保留天數** (`loggerService.js` 第 467 行)

   ```javascript
   this.cleanupOldLogs(365); // 預設保留 1 年（365 天）
   ```

3. **備份檔案類型** (`loggerService.js` 第 385 行)

   ```javascript
   const backupPath = `${filename}.${timestamp}.bak`; // .bak 後綴
   ```

4. **重複訊息過濾時間** (`loggerService.js` 第 20 行)

   ```javascript
   this.duplicateThreshold = 5000; // 5 秒
   ```

5. **監控告警閾值** (`loggerService.js` 第 289-291 行)

   ```javascript
   const warningThresholdMB = 500;      // 500MB 警告
   const criticalThresholdMB = 1000;    // 1GB 嚴重警告
   const fileCountWarning = 100;        // 100 個檔案警告
   const singleFileWarningMB = 50;      // 單檔案 50MB 警告
   ```

---

## ✅ 已實現的功能

### 1. 清理統計報告 ✅

- **實現**: 每次維護任務執行後自動生成統計報告
- **內容**:
  - 刪除的檔案數量
  - 釋放的空間（MB）
  - 清理前後的目錄大小和檔案數量
  - 當前目錄狀態
- **位置**: `loggerService.js` - `generateCleanupReport()`
- **輸出**: 自動記錄到 `app.log`
- **格式**: `📊 [清理統計] 刪除檔案: X 個 | 釋放空間: XMB | 當前目錄: XMB (X 個檔案)`

### 2. 日誌監控告警 ✅

- **實現**: 每次維護任務執行前自動檢查並發出告警
- **告警類型**:
  - **容量告警**: 目錄超過 500MB（警告）或 1GB（嚴重警告）
  - **檔案數量告警**: 超過 100 個檔案時警告
  - **單檔案大小告警**: 單個檔案超過 50MB 時警告
- **位置**: `loggerService.js` - `checkLogDirectoryCapacity()`
- **輸出**: 自動記錄到錯誤日誌（`error.log`）

### 3. 統一清理機制 ✅

- **實現**: 清理任務同時處理 `.log` 和 `.bak` 檔案
- **正則表達式**: `/\.(log|bak)$/`
- **結果**: 避免備份檔案累積

### 4. 優化輪轉邏輯 ✅

- **實現**: 改為清空檔案而不是刪除，保持檔案持續寫入
- **流程**: 先記錄（創建 `.bak`）→ 再清空（原檔案）
- **結果**: 確保備份成功後才清空原檔案，避免日誌丟失

### 5. 精簡架構 ✅

- **實現**: 將輪轉和清理整合為單一維護任務
- **改進**: 從兩個獨立定時器精簡為一個
- **結果**: 減少定時器數量，邏輯更清晰

### 6. 精簡日誌類別 ✅

- **實現**: 
  - 合併 `system()` 和 `service()` 為統一的 `info()` 方法
  - 移除 5 個未使用的方法
  - 保留向後兼容：`system()` 和 `service()` 仍然可用
- **結果**: 核心方法從 15 個精簡到 9 個

### 7. 統一重複訊息過濾 ✅

- **實現**: 統一時間閾值為 5 秒
- **改進**: `isDuplicateMessage()` 使用 `this.duplicateThreshold` 而非硬編碼
- **結果**: 時間閾值統一，可透過配置調整

---

## 📝 使用指南

### 查看日誌

```bash
# 查看應用日誌（即時）
npm run logs-app

# 查看錯誤日誌（即時）
npm run logs-error

# 查看 PM2 日誌
npm run logs
```

### 檢查清理狀態

**注意**: 日誌清理已完全自動化，無需手動執行。系統會每 24 小時自動執行日誌維護（監控告警 → 輪轉 → 清理 → 統計報告）。

```bash
# 透過 API 檢查清理狀態
curl http://localhost:6000/api/cleanup/status
```

### 監控告警說明

系統會自動監控日誌目錄，當出現以下情況時會發出告警：

- **容量警告**: 目錄超過 500MB
- **嚴重警告**: 目錄超過 1GB
- **檔案數量警告**: 超過 100 個檔案
- **單檔案大小警告**: 單個檔案超過 50MB

所有告警會自動記錄到 `error.log`，格式為 `⚠️ [日誌告警]` 或 `🚨 [日誌告警]`。

---

## 🔐 安全考量

1. **日誌檔案權限**
   - 確保日誌檔案有適當的讀寫權限
   - 避免敏感資訊（如 API Key）寫入日誌

2. **日誌內容過濾**
   - 已實現重複訊息過濾（5 秒內相同訊息不重複記錄）
   - 建議對敏感資訊進行脫敏處理

3. **清理安全**
   - 清理前確認檔案年齡，避免誤刪
   - 保留足夠的歷史記錄（1 年）用於問題排查
   - 先備份再清理，確保資料安全

---

## ✅ 總結

經過全面改進後，日誌處理與清除機制現在具有以下優點：

1. ✅ **統一管理**: 透過 `LoggerService` 統一管理所有日誌
2. ✅ **完全自動化**: 自動輪轉、清理、監控和統計，無需手動干預
3. ✅ **職權分離**: 日誌服務與檔案系統服務職責清晰
4. ✅ **可配置**: 保留期限、輪轉大小、告警閾值均可調整
5. ✅ **機制統一**: 輪轉和清理機制已協調，避免檔案累積
6. ✅ **先記錄再刪除**: 確保備份成功後才清空原檔案，避免日誌丟失
7. ✅ **監控告警**: 自動監控目錄狀態，及時發現問題
8. ✅ **統計報告**: 自動生成清理統計，便於追蹤維護效果
9. ✅ **精簡高效**: 架構精簡，代碼清晰，維護方便

### 改進歷程（2025-11-28）

- ✅ **統一清理機制**: 清理任務現在同時處理 `.log` 和 `.bak` 檔案
- ✅ **優化輪轉邏輯**: 改為清空檔案而不是刪除，保持檔案持續寫入
- ✅ **精簡架構**: 將輪轉和清理整合為單一維護任務，從兩個獨立定時器精簡為一個
- ✅ **移除手動清理腳本**: 統一使用自動清理機制，簡化維護流程
- ✅ **精簡日誌類別**: 合併重複方法，移除未使用方法，保留向後兼容
- ✅ **統一重複訊息過濾**: 時間閾值統一為 5 秒，使用配置而非硬編碼
- ✅ **實現清理統計報告**: 自動生成詳細的清理統計報告
- ✅ **實現日誌監控告警**: 自動監控目錄容量、檔案數量和單檔案大小
- ✅ **調整保留期限**: 從 7 天調整為 1 年（365 天）

### 未來可考慮的改進

1. **日誌壓縮**
   - 考慮對舊日誌進行壓縮（`.gz`）以節省空間
   - 可以保留更長時間的歷史記錄

2. **日誌分級清理**
   - 不同級別的日誌可以有不同的保留期限
   - 例如：錯誤日誌保留更長時間，調試日誌保留較短時間

---

**最後更新**: 2025-11-28  
**版本**: 2.0.0
